import{_ as nt,i as it,h as ut,r as v,x as j,G as $,y as vt,z as dt,o as pt,q as H,b as u,c as d,k as Q,w as N,A as R,d as s,l as K,T as ht,F as I,t as f,H as _t,e as T,u as ft,v as W,B as X,C as Y,p as Ct,g as gt}from"./index-1c6f3158.js";import{u as yt}from"./store-09b99b65.js";import{M as Dt}from"./Modal-728e6302.js";import{L as mt}from"./Loading-fe516877.js";/* empty css                                                              */const D=m=>(Ct("data-v-cd2ae546"),m=m(),gt(),m),St={id:"shopCart-container"},Lt={key:1,id:"shopCart-all"},wt=D(()=>s("div",{id:"shopCart-title"},"購物車",-1)),It={id:"shopCart-main"},kt={id:"shopCartFrame"},Pt={key:0,id:"shopCart-noList"},zt=["onClick"],bt=["onClick"],qt=["src"],$t={class:"shopCart-productDetail"},Nt=["onClick"],Tt=D(()=>s("div",{class:"shopCart-gender"},"男",-1)),Vt={class:"shopCart-select"},Mt=["onUpdate:modelValue","onChange"],Ut=["value"],At=["onUpdate:modelValue","onChange"],Bt=["value"],Ft={class:"shopCart-price"},Jt={id:"shopCart-priceFrame"},Ot={id:"shopCart-box"},Et=D(()=>s("div",{id:"shopCart-little"},"小計",-1)),Gt={class:"shopCart-priceLeft"},jt=D(()=>s("div",{id:"shopCart-discount"},"折扣",-1)),Ht={class:"shopCart-priceLeft"},Qt=D(()=>s("div",{id:"shopCart-total"},"總計(不含運費)",-1)),Rt={class:"shopCart-priceLeft"},Kt={__name:"ShopCart",setup(m){const k=it("config"),P=yt(),V=ut(),S=v(!1),z=v(""),r=v({cartList:[]}),l=v({cartData:[]}),L=v(0),p=j(()=>et()),h=v("無折扣"),M=j(()=>ot()),C=$(new Array(l.value.cartData.length).fill(null)),n=$(new Array(l.value.cartData.length).fill(null)),g=$(new Array(l.value.cartData.length).fill([])),U=v(!1),A=v(!0),b=v(!0),B=v(!1),F=async()=>{const t=P.cartData;let a=JSON.parse(JSON.stringify(t));return console.log("%c vue拿到本地資料","color: yellow; font-weight: bold",a),a},y=async t=>{try{P.updateCartData(t),console.log("%c 已更新本地購物車資料","color: white; font-weight: bold",await F())}catch{console.log("更新本地資料失敗")}},Z=async t=>{try{P.updatePriceData(t)}catch{console.log("更新本地資料失敗")}};function J(t,a){const o=l.value.cartData[t],c=C[t],e=o.inventory.find(_=>_.productSize===c);if(e){const _=e.inventory;g[t]=new Array(_).fill().map((w,i)=>i+1),a||(n[t]=1)}else g[t]=[],n[t]=null}const x=async t=>{const a=l.value.cartData[t],o=C[t],c=n[t],e=a.inventory.find(i=>i.productSize===o).productSizeID,_=r.value.cartList.findIndex(i=>i.productSizeID===e),w=a.inventory.find(i=>i.productSizeID===e).inventory;if(_!==-1){const i=r.value.cartList[_],q=i.quantity+c;q<=w?(i.quantity=q,n[_]=q):(i.quantity=w,n[_]=w),r.value.cartList.splice(t,1),C.splice(t,1),n.splice(t,1),g.splice(t,1),l.value.cartData=r.value.cartList.map(E=>{const G=l.value.cartData.find(rt=>rt.productSizeID===E.productSizeID);return console.log(G,"搜尋到的資料更改=-=-=-=-=-=-="),{...G,quantity:E.quantity}})}else J(t,!1),r.value.cartList.splice(t,1,{productSizeID:e,quantity:c,productSize:o}),l.value.cartData[t].productSizeID=e,l.value.cartData[t].quantity=c,l.value.cartData[t].productSize=o,await y(r.value.cartList)},tt=async(t,a)=>{r.value.cartList[t].quantity=a;const o=l.value.cartData[t];o.quantity=a,await y(r.value.cartList)};function O(t){V.push({name:"Product",params:{id:t},props:{id:t}})}function at(t){const a=l.value.cartData[t],o=n[t];return a.price*o}function et(){return l.value.cartData.reduce((t,a,o)=>{const c=n[o];return t+a.price*c},0)}function ot(){if(p.value>=1e4&&L.value===0&&(h.value="9折"),L.value===1&&(h.value="8折"),p.value<1e4&&L.value===0&&(h.value="無折扣"),h.value==="無折扣")return p.value;if(h.value==="9折")return p.value*.9;if(h.value==="8折")return p.value*.8}const st=async t=>{r.value.cartList.splice(t,1),l.value.cartData.splice(t,1),C.splice(t,1),n.splice(t,1),g.splice(t,1),y(r.value.cartList),U.value===!0&&await H(r.value,`${k.apiUrl}/updateCart`)},ct=async()=>{let t={subTotal:p.value,discount:h.value,totalPrice:M.value};Z(t),y(r.value.cartList),V.push("/shopCartNext")},lt=async()=>{if(p.value!==0)return ct();z.value="購物車沒有商品",S.value=!0,console.log("購物車沒有商品")};return vt(async()=>{dt().then(t=>{let a=t.isLogin;U.value=a,console.log("%c 登入狀況::","color: red; font-weight: bold",a)}).catch(t=>{console.log("重新讀取")})}),pt(async()=>{let t=await F();const a=await H(t,`${k.apiUrl}/cart`);l.value={cartData:a.cartData},r.value={cartList:a.cartList},a.level&&(L.value=a.level),console.log("%c cartData::ref已寫入","color: green; font-weight: bold",l.value),console.log("%c cartList::ref已寫入","color: green; font-weight: bold",r.value),console.log("%c memberLevel::ref已寫入","color: green; font-weight: bold",a.level),console.log(l.value.cartData.length,"+++++++"),await y(r.value.cartList),l.value.cartData.forEach((o,c)=>{C[c]=o.inventory[0].productSize,n[c]=o.quantity>o.inventory[0].inventory?o.inventory[0].inventory:o.quantity,J(c,!0),l.value.cartData.length===0?b.value=!0:b.value=!1,B.value=a.cartData.some(e=>e.inventoryShortage),B.value&&(z.value="有部分商品缺貨 購物車商品已更改",S.value=!0)}),setTimeout(()=>{A.value=!1},1e3)}),(t,a)=>(u(),d(I,null,[S.value?(u(),Q(Dt,{key:0,onClose:a[0]||(a[0]=o=>S.value=!1)},{default:N(()=>[s("p",null,f(z.value),1)]),_:1})):R("",!0),s("div",St,[K(ht,{name:"fade",mode:"out-in"},{default:N(()=>[A.value===!0?(u(),Q(mt,{key:0})):(u(),d("div",Lt,[wt,s("div",It,[s("div",kt,[b.value===!0?(u(),d("div",Pt," 尚無商品")):R("",!0),K(_t,{name:"list",tag:"ul"},{default:N(()=>[(u(!0),d(I,null,T(l.value.cartData,(o,c)=>(u(),d("div",{key:c,class:"shopCart-product"},[s("div",{class:"shopCart-delete",onClick:e=>st(c)},"x",8,zt),s("div",{onClick:e=>O(o.productID),class:"shopCart-productPic"},[s("img",{src:`${ft(k).picUrl}/`+o.imgSrc},null,8,qt)],8,bt),s("div",$t,[s("div",{onClick:e=>O(o.productID),class:"shopCart-productName"},f(o.productName),9,Nt),Tt,s("div",Vt,[W(" 尺寸 "),X(s("select",{class:"shopCart-size","onUpdate:modelValue":e=>C[c]=e,onChange:e=>x(c)},[(u(!0),d(I,null,T(o.inventory,e=>(u(),d("option",{key:e.productSizeID,value:e.productSize},f(e.productSize),9,Ut))),128))],40,Mt),[[Y,C[c]]]),W(" 數量 "),X(s("select",{class:"shopCart-count","onUpdate:modelValue":e=>n[c]=e,onChange:e=>tt(c,n[c])},[(u(!0),d(I,null,T(g[c],e=>(u(),d("option",{key:e,value:e},f(e),9,Bt))),128))],40,At),[[Y,n[c]]])])]),s("div",Ft,f(at(c))+"$",1)]))),128))]),_:1})]),s("div",Jt,[s("div",Ot,[Et,s("div",Gt,f(p.value),1),jt,s("div",Ht,f(h.value),1),Qt,s("div",Rt,f(M.value),1)]),s("button",{id:"shopCart-next",onClick:a[1]||(a[1]=o=>lt())},"下一步")])])]))]),_:1})])],64))}},ta=nt(Kt,[["__scopeId","data-v-cd2ae546"]]);export{ta as default};
